<!DOCTYPE html>
<html>
<header>

    <style>
        .contentEditableCSS {
            width: 400px;
            height: 200px;
            padding: 20px;
            margin: 50px auto;
            background: yellow;
            position: absolute;
            opacity: 0.5;
            left: 600px;
            top: 150px;
        }
        .TestCoordinates{
           width: 1px;
            height: 16px;
            padding: 0px;
            margin: 50px auto;
            background: red;
            position: absolute;
            opacity: 0.5;
            left: 639px;
            top: 170px; 
        }
        
    </style>


</header>
<!--<div class="TestCoordinates"></div> -->

<div class="locator" id="boxoutline"></div>

<div contenteditable="true" class="contentEditableCSS" id="foo">D D D D D D D D  D D D D D D </div>

<body>
  <div id="div1">The text above has been created dynamically.</div>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script>
    $(document).ready(function() {
       // getCoordinates()
        var TextBox=createTextBoxObject('foo');
        var wordList =[]
        wordList= createWordObjectList('foo');
        
        createUnderlineDivAt(TextBox,wordList);
        console.log('shouldprint');
    //createUnderline(wordList[0]);
    //createUnderline(wordList[1]);
    //createUnderline(wordList[2]);
    //createUnderline(wordList[3]);
    //createUnderline(wordList[4]);
    //var el = document.getElementById("foo");
    //selectElementContents(el);
    });
    
    function createTextBoxObject(id) {

        var elem = document.getElementById(id);

        let compStyles = window.getComputedStyle(elem);

        range = document.createRange();
        range.selectNode(document.getElementsByTagName("div").item(0));
        rectList = range.getClientRects();

        let rect = elem.getBoundingClientRect();
        return rect;
        
            /*
             var textBoxObject = {BoxHeight:rect.height,BoxWidth:rect.width,BoxBottom:bottom,BoxLeft:rect.left,BoxRight:rect.right,BoxTop:rect.top,BoxX:rect.x,BoxY:rect.y,BoxPaddingLeft:compStyles.getPropertyValue('padding-left'),BoxPosition:rect.position}
       */

        /*
                var padding = compStyles.getPropertyValue('padding-left')
                var bottom = +rect.bottom
                var height = 16 + "px"
                var left = rect.left + 20 + "px"
                var right = rect.right + 'px'
                var top = rect.top + 20 + "px"
                var width = 16 + "px"
                var opacity = .6 + ''
                var background = "red"
                var position = 'absolute'
                */
            }
        
  
    function get_text_width(txt, font) {
    this.element = document.createElement('canvas');
    this.context = this.element.getContext("2d");
    this.context.font = font;
        
    return this.context.measureText(txt).width;
    }
    
    
    //returns a list of words with widths and heights.
    function createWordObjectList(id) {
        //get outer box dimensions
        //var TextboxWidth=$('foo')
        //var TextboxHeight=
        //get padding
        //split words on " "
        //for each word calculate its size
        
        
        let compStyles = window.getComputedStyle(document.getElementById(id));
        
        
        let wordHeight = compStyles.getPropertyValue('line-height')+'';
        let wordFontSize=compStyles.getPropertyValue('font-size')+'';
        
    
        let list = (document.getElementById(id).innerHTML).split(" ");
        
        
        
        
        let wordObjectList=[];
        for (i=0;i<list.length;i++)
        {
            //console.log(list[i]);
            let textDim = wordFontSize +" "+wordHeight;
            
            //console.log('Calculated width ' + get_text_width(list[i],textDim));
            
            textStr=list[i]+'';
           
          
            let wordObject = {text:textStr,height:wordFontSize,width:get_text_width(list[i],textDim),split_width:get_text_width(" ",textDim)}
        
           // console.log(wordObject.text);
            wordObjectList[i]=(wordObject);
            //console.log(wordObject.height);
            //console.log(wordObjectList[i].text);
           // console.log(wordObjectList[i].width);
            //console.log(textDim);
            
            
           
           // console.log(wordObjectList[0].text);
        }
            
        
            return wordObjectList;                               
        

        
        


    }
    
    function createUnderlineDivAt(textBoxObject,wordObjectList){
    
        let currentWidth=0;
        let currentRow=0;
      
        
        let MaxWidth=textBoxObject.width;
        let MaxHeight=textBoxObject.height;
        let wordCount=0;
        //margins - 20 for current top 50-20 = 30 so top -30
        
        let currentTop = textBoxObject.top-30;
        var currentLeft = textBoxObject.left+20;
      console.log("the current top is " +currentTop);
    for(i=0;i<wordObjectList.length;i++){
        
        if (typeof wordObjectList[i] === 'undefined'){
            
            console.log("UNDEFINED");
        }
       
       
        let wordObject = wordObjectList[i];
            
        
       
      
        //console.log("current width is "+currentWidth);
        console.log(wordObject.text);
        console.log(currentWidth);
        if(currentWidth+wordObject.width>=textBoxObject.width-90){
            console.log('currentWidth is larger');
        
           //currentRow+=1;
            currentTop+=20;
            currentWidth=0;
            currentLeft=textBoxObject.left+20;
            
            
        //console.log(currentRow);
        }
            currentWidth+=wordObject.width;
        
        
       // console.log('width: '+ wordObject.width);
         $("<style type='text/css'> .misSpell"+i+"{ width: "+ wordObject.width+ "px;height: 16px;padding: 0px;margin: 50px auto;background: red;position: absolute;opacity: 0.5;left: "+currentLeft+"px;top:"+currentTop+"px; } </style>").appendTo("head");
    $("<div/>").addClass("misSpell" +i).appendTo("body");
        currentLeft+=wordObject.width+4;
        //console.log("current left" +currentLeft);
        //console.log("textBox left" + textBoxObject.left);
        //$("<style type='text/css'> .misSpell"+i+"{ width: "+ wordObject.width+ "px;height: 16px;padding: 0px;margin: 50px auto;background: red;position: absolute;opacity: 0.5;left: "+currentLeft+"px;top:"+currentTop+"px; } </style>").appendTo("head");
   // $("<div/>").addClass("misSpell" +i).appendTo("body");
        
    
        
    }
    
    }
    
</script>

</html>
